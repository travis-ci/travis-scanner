#!/usr/bin/env ruby

require 'optparse'

options = {}
OptionParser.new do |opt|
  opt.on('--scan_path PATH') { |o| options[:scan_path] = o }
end.parse!

scan_path = options[:scan_path]
Dir.entries(scan_path).each do |file|
  current_file = File.join(scan_path, file)
  if File.directory?(current_file)
    next
  end
  line_num = 1
  File.open(current_file).each do |line|
    column_nums = line.to_enum(:scan, /AKIA[0-9A-Z]{16}/).map { Regexp.last_match.begin(0) + 1 }
    column_nums.each do |column_num|
      print "Finding: %s File: %s Line: %d Column: %d Size: %d\n" % ["AWS KEY", file, line_num, column_num, 20]
    end
    line_num += 1
  end
end
